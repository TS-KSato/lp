<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>ピコそろ - Professional Abacus Calculator</title>
  
  <style>
    /* システムフォント優先、美しいタイポグラフィ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      /* 洗練されたモノクロームパレット */
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --bg-tertiary: #141414;
      --text-primary: #ffffff;
      --text-secondary: #8e8e93;
      --text-tertiary: #48484a;
      --accent: #007aff;
      --success: #34c759;
      --warning: #ff9500;
      --danger: #ff3b30;
      --border: #1c1c1e;
      --shadow: rgba(0, 0, 0, 0.8);
      
      /* セーフエリア */
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      
      /* タイポグラフィ */
      --font-system: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic UI", "Meiryo UI", sans-serif;
      --font-mono: "SF Mono", "Monaco", "Menlo", "Courier New", monospace;
    }

    body {
      font-family: var(--font-system);
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      position: fixed;
      width: 100%;
      user-select: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* メインコンテナ */
    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
    }

    /* ヘッダー - 極めてシンプル */
    .header {
      padding: 12px 20px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header__title {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .header__actions {
      display: flex;
      gap: 16px;
    }

    .header__button {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 15px;
      font-weight: 500;
      padding: 4px;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .header__button:active {
      opacity: 0.6;
    }

    /* 算盤セクション */
    .abacus {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      min-height: 0;
    }

    .abacus__display {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border);
    }

    .abacus__value {
      font-family: var(--font-mono);
      font-size: 32px;
      font-weight: 300;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .abacus__label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* 算盤フレーム */
    .abacus__frame {
      flex: 1;
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px 16px;
      position: relative;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--border);
    }

    .abacus__container {
      height: 100%;
      min-width: 600px;
      position: relative;
    }

    .abacus__rods {
      display: flex;
      height: 100%;
      gap: 8px;
      padding: 0 8px;
    }

    .abacus__rod {
      flex: 1;
      position: relative;
      min-width: 64px;
    }

    .abacus__rod-line {
      position: absolute;
      width: 2px;
      height: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-tertiary);
      opacity: 0.3;
    }

    .abacus__divider {
      position: absolute;
      width: 100%;
      height: 2px;
      background: var(--text-tertiary);
      top: 35%;
      left: 0;
      opacity: 0.5;
    }

    /* 珠のスタイル - シンプルで美しい */
    .bead {
      position: absolute;
      width: 48px;
      height: 24px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 12px;
      background: linear-gradient(135deg, #f5f5f7 0%, #d1d1d6 100%);
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .bead--heaven {
      top: 15%;
      background: linear-gradient(135deg, #ff9500 0%, #ff7a00 100%);
    }

    .bead--heaven.active {
      transform: translateX(-50%) translateY(60px);
    }

    .bead--earth {
      background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
    }

    .bead--earth:nth-child(3) { bottom: 55%; }
    .bead--earth:nth-child(4) { bottom: 44%; }
    .bead--earth:nth-child(5) { bottom: 33%; }
    .bead--earth:nth-child(6) { bottom: 22%; }
    .bead--earth:nth-child(7) { bottom: 11%; }

    .bead--earth.active {
      transform: translateX(-50%) translateY(-80px);
    }

    /* 桁ラベル */
    .rod__label {
      position: absolute;
      bottom: -28px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--text-tertiary);
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    /* 電卓セクション */
    .calculator {
      background: var(--bg-secondary);
      border-radius: 24px 24px 0 0;
      padding: 20px 16px calc(var(--safe-bottom) + 16px);
      box-shadow: 0 -4px 24px var(--shadow);
      border-top: 1px solid var(--border);
    }

    /* 電卓ディスプレイ */
    .calculator__display {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 64px;
      border: 1px solid var(--border);
    }

    .calculator__expression {
      font-size: 14px;
      color: var(--text-secondary);
      min-height: 20px;
      font-family: var(--font-mono);
    }

    .calculator__value {
      font-size: 36px;
      font-weight: 300;
      font-family: var(--font-mono);
      letter-spacing: -0.03em;
      color: var(--text-primary);
      line-height: 1;
    }

    /* 電卓ボタングリッド */
    .calculator__grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    /* ボタンスタイル - Appleライク */
    .btn {
      aspect-ratio: 1.3;
      border: none;
      border-radius: 12px;
      font-size: 20px;
      font-weight: 500;
      color: var(--text-primary);
      background: var(--bg-tertiary);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.15s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      min-height: 56px;
    }

    .btn__number {
      font-size: 24px;
      font-weight: 400;
      line-height: 1;
    }

    .btn__sub {
      font-size: 10px;
      color: var(--text-secondary);
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .btn:active {
      transform: scale(0.98);
      background: var(--border);
    }

    /* ボタンタイプ別スタイル */
    .btn--number {
      background: #1c1c1e;
    }

    .btn--operator {
      background: var(--accent);
      color: white;
    }

    .btn--operator:active {
      background: #0051d5;
    }

    .btn--equals {
      background: var(--success);
      color: white;
    }

    .btn--equals:active {
      background: #248a3d;
    }

    .btn--clear {
      background: var(--danger);
      color: white;
    }

    .btn--memory {
      background: var(--warning);
      color: white;
      font-size: 16px;
    }

    /* 履歴パネル */
    .history {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 280px;
      background: var(--bg-secondary);
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
      display: flex;
      flex-direction: column;
      box-shadow: -4px 0 24px var(--shadow);
    }

    .history.active {
      transform: translateX(0);
    }

    .history__header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history__title {
      font-size: 17px;
      font-weight: 600;
    }

    .history__close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }

    .history__close:active {
      background: var(--bg-tertiary);
    }

    .history__content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .history__item {
      padding: 12px;
      border-radius: 8px;
      background: var(--bg-tertiary);
      margin-bottom: 8px;
      font-family: var(--font-mono);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .history__item:active {
      background: var(--border);
    }

    .history__expression {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .history__result {
      font-size: 18px;
      color: var(--text-primary);
    }

    /* オーバーレイ */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 99;
    }

    .overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* レスポンシブ調整 */
    @media (max-width: 375px) {
      .btn {
        font-size: 18px;
        min-height: 48px;
      }
      
      .btn__number {
        font-size: 20px;
      }
      
      .calculator__value {
        font-size: 32px;
      }
    }

    /* アクセシビリティ */
    @media (prefers-reduced-motion: reduce) {
      * {
        transition-duration: 0.01ms !important;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* フォーカス表示 */
    *:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ヘッダー -->
    <header class="header">
      <h1 class="header__title">算盤電卓 Pro</h1>
      <div class="header__actions">
        <button class="header__button" id="historyBtn" aria-label="履歴を表示">履歴</button>
      </div>
    </header>

    <!-- 算盤セクション -->
    <section class="abacus" aria-label="算盤">
      <div class="abacus__display">
        <div>
          <div class="abacus__label">現在値</div>
          <div class="abacus__value" id="abacusValue">0</div>
        </div>
      </div>
      
      <div class="abacus__frame">
        <div class="abacus__container">
          <div class="abacus__rods" id="abacusRods">
            <div class="abacus__divider"></div>
            <!-- 動的に生成 -->
          </div>
        </div>
      </div>
    </section>

    <!-- 電卓セクション -->
    <section class="calculator" aria-label="電卓">
      <div class="calculator__display">
        <div class="calculator__expression" id="expression"></div>
        <div class="calculator__value" id="display">0</div>
      </div>
      
      <div class="calculator__grid">
        <!-- 1行目 -->
        <button class="btn btn--clear" data-action="clear">
          <span class="btn__number">C</span>
        </button>
        <button class="btn btn--memory" data-action="memory-clear">MC</button>
        <button class="btn btn--memory" data-action="memory-add">M+</button>
        <button class="btn btn--memory" data-action="memory-recall">MR</button>
        
        <!-- 2行目 -->
        <button class="btn btn--number" data-action="number" data-value="7">
          <span class="btn__number">7</span>
          <span class="btn__sub">七</span>
        </button>
        <button class="btn btn--number" data-action="number" data-value="8">
          <span class="btn__number">8</span>
          <span class="btn__sub">八</span>
        </button>
        <button class="btn btn--number" data-action="number" data-value="9">
          <span class="btn__number">9</span>
          <span class="btn__sub">九</span>
        </button>
        <button class="btn btn--operator" data-action="operator" data-value="÷">
          <span class="btn__number">÷</span>
        </button>
        
        <!-- 3行目 -->
        <button class="btn btn--number" data-action="number" data-value="4">
          <span class="btn__number">4</span>
          <span class="btn__sub">四</span>
        </button>
        <button class="btn btn--number" data-action="number" data-value="5">
          <span class="btn__number">5</span>
          <span class="btn__sub">五</span>
        </button>
        <button class="btn btn--number" data-action="number" data-value="6">
          <span class="btn__number">6</span>
          <span class="btn__sub">六</span>
        </button>
        <button class="btn btn--operator" data-action="operator" data-value="×">
          <span class="btn__number">×</span>
        </button>
        
        <!-- 4行目 -->
        <button class="btn btn--number" data-action="number" data-value="1">
          <span class="btn__number">1</span>
          <span class="btn__sub">一</span>
        </button>
        <button class="btn btn--number" data-action="number" data-value="2">
          <span class="btn__number">2</span>
          <span class="btn__sub">二</span>
        </button>
        <button class="btn btn--number" data-action="number" data-value="3">
          <span class="btn__number">3</span>
          <span class="btn__sub">三</span>
        </button>
        <button class="btn btn--operator" data-action="operator" data-value="-">
          <span class="btn__number">−</span>
        </button>
        
        <!-- 5行目 -->
        <button class="btn btn--number" data-action="number" data-value="0">
          <span class="btn__number">0</span>
          <span class="btn__sub">零</span>
        </button>
        <button class="btn btn--number" data-action="number" data-value="00">
          <span class="btn__number">00</span>
        </button>
        <button class="btn btn--equals" data-action="equals">
          <span class="btn__number">=</span>
        </button>
        <button class="btn btn--operator" data-action="operator" data-value="+">
          <span class="btn__number">+</span>
        </button>
      </div>
    </section>

    <!-- 履歴パネル -->
    <aside class="history" id="historyPanel" aria-label="計算履歴">
      <div class="history__header">
        <h2 class="history__title">計算履歴</h2>
        <button class="history__close" id="historyClose" aria-label="履歴を閉じる">×</button>
      </div>
      <div class="history__content" id="historyContent">
        <!-- 動的に生成 -->
      </div>
    </aside>

    <!-- オーバーレイ -->
    <div class="overlay" id="overlay"></div>
  </div>

  <script>
    // アプリケーション状態
    const state = {
      displayValue: '0',
      expression: '',
      firstOperand: null,
      waitingForOperand: false,
      operator: null,
      memory: 0,
      history: []
    };

    // DOM要素
    const elements = {
      display: document.getElementById('display'),
      expression: document.getElementById('expression'),
      abacusValue: document.getElementById('abacusValue'),
      abacusRods: document.getElementById('abacusRods'),
      historyBtn: document.getElementById('historyBtn'),
      historyPanel: document.getElementById('historyPanel'),
      historyClose: document.getElementById('historyClose'),
      historyContent: document.getElementById('historyContent'),
      overlay: document.getElementById('overlay'),
      buttons: document.querySelectorAll('.btn')
    };

    // 初期化
    function init() {
      createAbacus();
      attachEventListeners();
      updateDisplay();
    }

    // 算盤生成（8桁）
    function createAbacus() {
      const digits = ['千万', '百万', '十万', '万', '千', '百', '十', '一'];
      
      for (let i = 0; i < 8; i++) {
        const rod = document.createElement('div');
        rod.className = 'abacus__rod';
        rod.dataset.position = i;

        // 縦線
        const line = document.createElement('div');
        line.className = 'abacus__rod-line';
        rod.appendChild(line);

        // 天珠（5の珠）
        const heavenBead = document.createElement('button');
        heavenBead.className = 'bead bead--heaven';
        heavenBead.dataset.type = 'heaven';
        heavenBead.dataset.position = i;
        heavenBead.setAttribute('aria-label', `${digits[i]}の位の5の珠`);
        rod.appendChild(heavenBead);

        // 地珠（1の珠）× 4
        for (let j = 0; j < 4; j++) {
          const earthBead = document.createElement('button');
          earthBead.className = 'bead bead--earth';
          earthBead.dataset.type = 'earth';
          earthBead.dataset.position = i;
          earthBead.dataset.index = j;
          earthBead.setAttribute('aria-label', `${digits[i]}の位の${j + 1}番目の珠`);
          rod.appendChild(earthBead);
        }

        // 桁ラベル
        const label = document.createElement('div');
        label.className = 'rod__label';
        label.textContent = digits[i];
        rod.appendChild(label);

        elements.abacusRods.appendChild(rod);
      }
    }

    // イベントリスナー設定
    function attachEventListeners() {
      // 電卓ボタン
      elements.buttons.forEach(btn => {
        btn.addEventListener('click', handleButtonClick);
      });

      // 算盤の珠
      document.querySelectorAll('.bead').forEach(bead => {
        bead.addEventListener('click', handleBeadClick);
      });

      // 履歴
      elements.historyBtn.addEventListener('click', showHistory);
      elements.historyClose.addEventListener('click', hideHistory);
      elements.overlay.addEventListener('click', hideHistory);

      // キーボード
      document.addEventListener('keydown', handleKeyPress);
    }

    // ボタンクリック処理
    function handleButtonClick(e) {
      const { action, value } = e.currentTarget.dataset;

      switch (action) {
        case 'number':
          inputNumber(value);
          break;
        case 'operator':
          inputOperator(value);
          break;
        case 'equals':
          calculate();
          break;
        case 'clear':
          clear();
          break;
        case 'memory-clear':
          state.memory = 0;
          break;
        case 'memory-add':
          state.memory += parseFloat(state.displayValue) || 0;
          break;
        case 'memory-recall':
          state.displayValue = String(state.memory);
          updateDisplay();
          break;
      }
    }

    // 数字入力
    function inputNumber(num) {
      if (state.waitingForOperand) {
        state.displayValue = num;
        state.waitingForOperand = false;
      } else {
        state.displayValue = state.displayValue === '0' ? num : state.displayValue + num;
        
        // 8桁制限
        if (state.displayValue.length > 8) {
          state.displayValue = state.displayValue.slice(0, 8);
        }
      }
      updateDisplay();
    }

    // 演算子入力
    function inputOperator(nextOperator) {
      const inputValue = parseFloat(state.displayValue);

      if (state.firstOperand === null) {
        state.firstOperand = inputValue;
        state.expression = `${inputValue} ${nextOperator}`;
      } else if (state.operator) {
        const result = performCalculation[state.operator](state.firstOperand, inputValue);
        state.displayValue = String(result);
        state.firstOperand = result;
        state.expression = `${result} ${nextOperator}`;
      }

      state.waitingForOperand = true;
      state.operator = nextOperator;
      updateDisplay();
    }

    // 計算実行
    function calculate() {
      if (state.firstOperand !== null && state.operator) {
        const inputValue = parseFloat(state.displayValue);
        const result = performCalculation[state.operator](state.firstOperand, inputValue);
        
        // 履歴に追加
        const historyItem = {
          expression: `${state.firstOperand} ${state.operator} ${inputValue}`,
          result: result,
          timestamp: new Date()
        };
        state.history.unshift(historyItem);
        if (state.history.length > 50) state.history.pop();
        
        state.displayValue = String(result);
        state.expression = '';
        state.firstOperand = null;
        state.operator = null;
        state.waitingForOperand = true;
        
        updateDisplay();
        updateHistory();
      }
    }

    // 計算処理
    const performCalculation = {
      '÷': (a, b) => Math.floor(a / b),
      '×': (a, b) => a * b,
      '+': (a, b) => a + b,
      '-': (a, b) => a - b,
      '−': (a, b) => a - b
    };

    // クリア
    function clear() {
      state.displayValue = '0';
      state.expression = '';
      state.firstOperand = null;
      state.waitingForOperand = false;
      state.operator = null;
      updateDisplay();
    }

    // 表示更新
    function updateDisplay() {
      elements.display.textContent = formatNumber(state.displayValue);
      elements.expression.textContent = state.expression;
      
      const value = Math.floor(Math.abs(parseFloat(state.displayValue))) || 0;
      elements.abacusValue.textContent = formatNumber(value);
      updateAbacus(value);
    }

    // 数値フォーマット
    function formatNumber(num) {
      const number = parseFloat(num) || 0;
      return number.toLocaleString('ja-JP');
    }

    // 算盤更新
    function updateAbacus(value) {
      // 全ての珠をリセット
      document.querySelectorAll('.bead').forEach(bead => {
        bead.classList.remove('active');
      });

      // 8桁に分解
      const digits = value.toString().padStart(8, '0').split('').map(Number);

      digits.forEach((digit, position) => {
        // 5以上なら天珠を動かす
        if (digit >= 5) {
          const heavenBead = document.querySelector(
            `.bead--heaven[data-position="${position}"]`
          );
          if (heavenBead) {
            heavenBead.classList.add('active');
          }
        }

        // 残りの値で地珠を動かす
        const earthCount = digit % 5;
        for (let i = 0; i < earthCount; i++) {
          const earthBead = document.querySelector(
            `.bead--earth[data-position="${position}"][data-index="${i}"]`
          );
          if (earthBead) {
            earthBead.classList.add('active');
          }
        }
      });
    }

    // 珠クリック処理
    function handleBeadClick(e) {
      const bead = e.currentTarget;
      const position = parseInt(bead.dataset.position);
      const type = bead.dataset.type;
      const isActive = bead.classList.contains('active');

      // 現在の算盤の値を計算
      let currentValue = 0;
      for (let i = 0; i < 8; i++) {
        let digitValue = 0;
        
        // 天珠の値
        const heavenBead = document.querySelector(
          `.bead--heaven[data-position="${i}"]`
        );
        if (heavenBead && heavenBead.classList.contains('active')) {
          digitValue += 5;
        }
        
        // 地珠の値
        const earthBeads = document.querySelectorAll(
          `.bead--earth[data-position="${i}"]`
        );
        earthBeads.forEach(b => {
          if (b.classList.contains('active')) {
            digitValue += 1;
          }
        });
        
        currentValue += digitValue * Math.pow(10, 7 - i);
      }

      // クリックされた珠の処理
      if (type === 'heaven') {
        if (isActive) {
          bead.classList.remove('active');
          currentValue -= 5 * Math.pow(10, 7 - position);
        } else {
          bead.classList.add('active');
          currentValue += 5 * Math.pow(10, 7 - position);
        }
      } else {
        const index = parseInt(bead.dataset.index);
        const samePositionBeads = document.querySelectorAll(
          `.bead--earth[data-position="${position}"]`
        );
        
        if (isActive) {
          // この珠より上の珠も非アクティブに
          for (let i = index; i < 4; i++) {
            if (samePositionBeads[i].classList.contains('active')) {
              samePositionBeads[i].classList.remove('active');
              currentValue -= Math.pow(10, 7 - position);
            }
          }
        } else {
          // この珠より下の珠もアクティブに
          for (let i = 0; i <= index; i++) {
            if (!samePositionBeads[i].classList.contains('active')) {
              samePositionBeads[i].classList.add('active');
              currentValue += Math.pow(10, 7 - position);
            }
          }
        }
      }

      // 値を更新
      state.displayValue = String(currentValue);
      state.expression = '';
      state.firstOperand = null;
      state.operator = null;
      state.waitingForOperand = false;
      updateDisplay();
    }

    // キーボード処理
    function handleKeyPress(e) {
      if (e.key >= '0' && e.key <= '9') {
        inputNumber(e.key);
      } else if (['+', '-', '*', '/'].includes(e.key)) {
        const keyMap = { '+': '+', '-': '-', '*': '×', '/': '÷' };
        inputOperator(keyMap[e.key]);
      } else if (e.key === 'Enter' || e.key === '=') {
        calculate();
      } else if (e.key === 'Escape') {
        clear();
      }
    }

    // 履歴表示
    function showHistory() {
      elements.historyPanel.classList.add('active');
      elements.overlay.classList.add('active');
      updateHistory();
    }

    // 履歴非表示
    function hideHistory() {
      elements.historyPanel.classList.remove('active');
      elements.overlay.classList.remove('active');
    }

    // 履歴更新
    function updateHistory() {
      elements.historyContent.innerHTML = '';
      
      if (state.history.length === 0) {
        elements.historyContent.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">履歴がありません</p>';
        return;
      }

      state.history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history__item';
        div.innerHTML = `
          <div class="history__expression">${item.expression}</div>
          <div class="history__result">= ${formatNumber(item.result)}</div>
        `;
        div.addEventListener('click', () => {
          state.displayValue = String(item.result);
          updateDisplay();
          hideHistory();
        });
        elements.historyContent.appendChild(div);
      });
    }

    // 初期化実行
    init();
  </script>
</body>
</html>
