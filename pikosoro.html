<!DOCTYPE html>
<html lang="ja" data-theme="auto">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>„Éî„Ç≥„Åù„Çç¬†Pro</title>
  <!-- Manifest (Base64‚Äëencoded JSON) ‚Üí PWA installable -->
  <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiUGlrb3Nvcm8gUHJvIiwic2hvcnRfbmFtZSI6IlBpa29zb3JvIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzAwMDAwMCIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIn0=">
  <style>
    /* -------- RESET -------- */
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;line-height:1.5;min-height:100vh;background:var(--bg);color:var(--fg);display:flex;flex-direction:column}

    /* -------- THEME TOKENS -------- */
    :root{
      --accent:#007aff;--radius:10px;
      --light-bg:#fafafa;--light-fg:#121212;--light-border:#d0d0d0;
      --dark-bg:#000000;--dark-fg:#ffffff;--dark-border:#3a3a3c;
    }
    @media(prefers-color-scheme:light){:root{--bg:var(--light-bg);--fg:var(--light-fg);--border:var(--light-border)}}
    @media(prefers-color-scheme:dark){:root{--bg:var(--dark-bg);--fg:var(--dark-fg);--border:var(--dark-border)}}
    html[data-theme="light"]{--bg:var(--light-bg);--fg:var(--light-fg);--border:var(--light-border)}
    html[data-theme="dark"]{--bg:var(--dark-bg);--fg:var(--dark-fg);--border:var(--dark-border)}

    /* -------- LAYOUT -------- */
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px}
    header h1{font-size:18px;font-weight:600}
    .icon-btn{width:36px;height:36px;font-size:20px;border:none;border-radius:var(--radius);background:none;color:var(--accent);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .icon-btn:active{opacity:.6}
    main{flex:1;display:flex;flex-direction:column;gap:16px;padding:0 16px 24px}

    /* -------- DISPLAY -------- */
    #valueDisplay{border:1px solid var(--border);padding:4px 8px;border-radius:var(--radius);font-size:28px;font-weight:500;text-align:right}

    /* -------- ABACUS -------- */
    .abacus{display:grid;grid-template-columns:repeat(13,minmax(0,1fr));gap:8px;justify-content:center;width:100%;margin:auto}
    .rod{display:flex;flex-direction:column;align-items:center;gap:4px}
    .bead{width:22px;height:22px;border-radius:50%;background:var(--accent);cursor:pointer;transition:transform .2s cubic-bezier(.4,0,.2,1)}
    .bead.top.active{transform:translateY(24px)}   /* ‰∏ã„Å∏ */
    .bead.bottom.active{transform:translateY(-24px)}/* ‰∏ä„Å∏ */
    .separator{grid-column:1/-1;height:2px;background:var(--border);margin-top:8px}

    /* -------- CALCULATOR -------- */
    .calculator{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .calc-btn{padding:12px 0;border:none;border-radius:var(--radius);font-size:18px;font-weight:500;background:#3a3a3c;color:#fff;cursor:pointer}
    .calc-btn.op{background:#58585a}
    .calc-btn.eq{background:var(--accent)}

    /* -------- TOAST -------- */
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) scale(.9);background:var(--fg);color:var(--bg);padding:8px 14px;border-radius:var(--radius);opacity:0;pointer-events:none;transition:transform .25s,opacity .25s}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}

    /* -------- ACCESSIBILITY -------- */
    *:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  </style>
</head>
<body>
  <header>
    <h1>„Éî„Ç≥„Åù„Çç¬†Pro</h1>
    <nav>
      <button class="icon-btn" id="themeBtn" aria-label="„ÉÜ„Éº„ÉûÂàáÊõø">üåì</button>
      <button class="icon-btn" id="infoBtn" aria-label="ÊÉÖÂ†±">‚ÑπÔ∏è</button>
    </nav>
  </header>

  <main>
    <div id="valueDisplay" aria-live="polite">0</div>
    <section id="abacus" class="abacus" aria-label="„Åù„Çç„Å∞„Çì"></section>
    <section id="calculator" class="calculator" aria-label="ÈõªÂçì"></section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="assertive"></div>

  <script>
    /* ---------- helpers ---------- */
    const $=s=>document.querySelector(s);
    const toast=msg=>{const t=$('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)};

    /* ---------- theme ---------- */
    $('#themeBtn').addEventListener('click',()=>{
      const r=document.documentElement;
      const next=r.dataset.theme==='dark'?'light':r.dataset.theme==='light'?'auto':'dark';
      if(next==='auto'){delete r.dataset.theme}else r.dataset.theme=next;
      toast(next==='auto'? 'Ëá™Âãï':`„ÉÜ„Éº„Éû:${next}`);
    });

    /* ---------- abacus ---------- */
    const RODS=13, BOTTOM=4;
    const abacusEl=$('#abacus');
    const state=Array.from({length:RODS},()=>({top:false,bottom:0}));

    // build rods
    for(let r=0;r<RODS;r++){
      const rod=document.createElement('div');rod.className='rod';
      // top bead
      const top=document.createElement('div');top.className='bead top';rod.appendChild(top);
      // spacer (visual)
      const spacer=document.createElement('div');spacer.style.height='8px';rod.appendChild(spacer);
      // bottom beads
      for(let i=0;i<BOTTOM;i++){
        const b=document.createElement('div');b.className='bead bottom';rod.appendChild(b);
      }
      abacusEl.appendChild(rod);
    }
    // separator line
    const sep=document.createElement('div');sep.className='separator';abacusEl.appendChild(sep);

    // update display
    const update=()=>{
      const value=state.reduce((sum,d,idx)=>sum+((d.top?5:0)+d.bottom)*10**(RODS-idx-1),0);
      $('#valueDisplay').textContent=value.toLocaleString('ja-JP');
    };

    abacusEl.addEventListener('click',e=>{
      const bead=e.target.closest('.bead');
      if(!bead) return;
      const rod=bead.parentElement;
      const rodIndex=[...abacusEl.children].filter(el=>el.classList.contains('rod')).indexOf(rod);
      const data=state[rodIndex];

      if(bead.classList.contains('top')){
        data.top=!data.top;
        bead.classList.toggle('active',data.top);
      }else{ // bottom beads
        const beads=[...rod.querySelectorAll('.bead.bottom')];
        const idx=beads.indexOf(bead); // 0‚Äëbased
        const target=idx+1;
        if(data.bottom===target){data.bottom=idx;}else{data.bottom=target;}
        beads.forEach((b,i)=>b.classList.toggle('active',i<data.bottom));
      }
      update();
    });
    update();

    /* ---------- calculator ---------- */
    const KEYS=['C','7','8','9','√∑','4','5','6','√ó','1','2','3','-','0','.','=','+'];
    const calcEl=$('#calculator');
    let expr='';
    KEYS.forEach(k=>{
      const btn=document.createElement('button');btn.textContent=k;btn.className='calc-btn';
      if('√∑√ó-++'.includes(k))btn.classList.add('op');
      if(k==='=')btn.classList.add('eq');
      btn.addEventListener('click',()=>{
        if(k==='C'){expr='';$('#valueDisplay').textContent='0';return;}
        if(k==='='){
          try{const result=Function(`return (${expr.replace(/√ó/g,'*').replace(/√∑/g,'/')})`)();expr=result.toString();toast(result);}catch{toast('Âºè„Ç®„É©„Éº');expr='';}
        }else{expr+=k;}
        $('#valueDisplay').textContent=expr||'0';
      });
      calcEl.appendChild(btn);
    });

    /* ---------- info ---------- */
    $('#infoBtn').addEventListener('click',()=>toast('„Éî„Ç≥„Åù„Çç¬†Pro¬†1.0.1'));
  </script>
</body>
</html>
