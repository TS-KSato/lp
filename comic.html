<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- セキュリティヘッダ -->
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://via.placeholder.com; connect-src 'self'; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
    <meta http-equiv="x-dns-prefetch-control" content="on">

    <!-- アプリ説明 -->
    <meta name="description" content="マンガアプリのプレビュー。最初の数ページを読んで、アプリをダウンロードしよう！">
    <meta name="theme-color" content="#4a6cf7">

    <title>マンガアプリ - プレビュー</title>

    <!-- フォント最適化 -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #ff6b6b;
            --accent-color: #ff6b6b;
            --text-color: #333333;
            --light-text: #ffffff;
            --bg-color: #f9f9f9;
            --overlay-background: rgba(0, 0, 0, 0.7);
            --overlay-text: #ffffff;
            --button-background: rgba(255, 255, 255, 0.2);
            --button-hover: rgba(255, 255, 255, 0.4);
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --text-color: #eaeaea; /* コントラスト強化 */
                --overlay-background: rgba(0, 0, 0, 0.8);
            }
        }

        /* prefers-reduced-motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* ==== ヘッダー ==== */
        #header {
            background: var(--primary-color);
            color: var(--light-text);
            padding: 10px 0;
            z-index: 1000;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }

        .header-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: 700;
            text-decoration: none;
            color: var(--light-text);
        }

        /* ==== ビューワー ==== */
        #manga-viewer {
            width: 100%;
            flex-grow: 1;
            position: relative;
            background-color: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #manga-pages {
            display: flex;
            position: relative;
            width: 100%;
            height: 100%;
            will-change: transform;
            transition: transform 0.3s ease;
        }

        .manga-page {
            flex: 0 0 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            position: relative;
            overflow: hidden;
        }

        .page-content {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
            transition: opacity 0.3s ease, filter 0.3s ease;
            pointer-events: none;
            opacity: 0;
        }

        .page-content.loaded {
            opacity: 1;
        }

        .page-content.loading {
            opacity: 0.5;
        }

        /* 4ページ目フィルター */
        .manga-page.page-filter-active .page-content.loaded {
            filter: brightness(50%);
        }

        /* ナビゲーションゾーン */
        .nav-zone {
            position: absolute;
            height: 100%;
            width: 30%;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        #prev-zone {
            left: 0;
        }

        #next-zone {
            right: 0;
        }

        #center-zone {
            left: 30%;
            width: 40%;
            cursor: default;
        }

        /* UI オーバーレイ */
        .ui-overlay {
            position: absolute;
            left: 0;
            width: 100%;
            padding: 10px 15px;
            color: var(--overlay-text);
            background-color: var(--overlay-background);
            z-index: 20;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0;
            pointer-events: none;
        }

        #manga-viewer.show-ui .ui-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        #top-overlay {
            top: 0;
            transform: translateY(-100%);
        }

        #bottom-overlay {
            bottom: 0;
            transform: translateY(100%);
        }

        #manga-viewer.show-ui #top-overlay,
        #manga-viewer.show-ui #bottom-overlay {
            transform: translateY(0);
        }

        /* UIボタン */
        .ui-button {
            background: none;
            border: none;
            color: var(--overlay-text);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ui-button svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }

        .ui-button:hover {
            opacity: 0.8;
        }

        .ui-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* アクションボタン */
        .action-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 12px 25px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            transition: opacity 0.3s ease, transform 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            text-align: center;
            z-index: 30;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            pointer-events: none;
            will-change: transform, opacity;
        }

        .action-button.visible {
            opacity: 1;
            pointer-events: auto;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.05);
            }
        }

        .action-button:focus-visible {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }

        /* ローディングスピナー */
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--light-text);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 50;
            display: none;
            transform: translate(-50%, -50%);
        }

        #loading-spinner.visible {
            display: block;
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- ヘッダー -->
    <header id="header">
        <div class="container header-container">
            <a href="#" class="logo">マンガアプリ プレビュー</a>
        </div>
    </header>

    <!-- ビューワー -->
    <section id="manga-viewer">
        <div id="manga-pages"><!-- JSが生成 --></div>

        <!-- ナビゲーション領域 -->
        <div class="nav-zone" id="prev-zone" aria-label="前のページへ"></div>
        <div class="nav-zone" id="center-zone" aria-label="UI表示切り替え"></div>
        <div class="nav-zone" id="next-zone" aria-label="次のページへ"></div>

        <!-- UI：上 -->
        <div class="ui-overlay" id="top-overlay">
            <span id="manga-title">サンプルマンガ</span>
            <span id="page-indicator" aria-live="polite">1 / 4</span>
        </div>

        <!-- UI：下 -->
        <div class="ui-overlay" id="bottom-overlay">
            <button class="ui-button" id="prev-button" aria-label="前のページへ" disabled>
                <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <title>前のページ</title>
                    <path d="M15.41,16.59L10.83,12l4.58-4.59L14,6l-6,6l6,6L15.41,16.59z"></path>
                </svg>
            </button>
            <span id="page-indicator-bottom">1 / 4</span>
            <button class="ui-button" id="next-button" aria-label="次のページへ">
                <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <title>次のページ</title>
                    <path d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z"></path>
                </svg>
            </button>
        </div>

        <!-- アクションボタン -->
        <a href="https://ts-ksato.github.io/comic/viewer.html"
           class="action-button"
           id="action-button"
           role="button"
           aria-label="ブラウザでマンガの続きを読む">
           続きはWEBで
        </a>

        <!-- スピナー -->
        <div id="loading-spinner"></div>
    </section>

    <!-- スクリプト -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            /* ---------- 設定 ---------- */
            const mangaPagesData = [
                /* 実際の画像に合わせて拡張子を統一してください */
                { src: 'i_004.jpg' },
                { src: 'i_007.jpg' },
                { src: 'i_008.jpg' },
                { src: 'i_009.jpg' }
            ];
            const totalPages = mangaPagesData.length;
            const ACTION_BUTTON_PAGE = 4;
            const SWIPE_THRESHOLD = 50;
            const IMAGE_W = 768;   // 実画像サイズに合わせて変更
            const IMAGE_H = 1280;

            /* ---------- 要素取得 ---------- */
            const mangaViewer = document.getElementById('manga-viewer');
            const mangaPagesContainer = document.getElementById('manga-pages');
            const pageIndicatorTop = document.getElementById('page-indicator');
            const pageIndicatorBottom = document.getElementById('page-indicator-bottom');
            const actionButton = document.getElementById('action-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const prevZone = document.getElementById('prev-zone');
            const nextZone = document.getElementById('next-zone');
            const centerZone = document.getElementById('center-zone');

            /* ---------- 状態 ---------- */
            let currentPage = 1;
            let isUIVisible = false;
            let isLoading = true;

            /* ---------- 初期化 ---------- */
            function initMangaViewer() {
                loadingSpinner.classList.add('visible');
                mangaPagesContainer.innerHTML = '';

                mangaPagesData.forEach((pageData, index) => {
                    const pageDiv = document.createElement('div');
                    pageDiv.classList.add('manga-page');
                    pageDiv.setAttribute('data-page-number', index + 1);

                    /* ---- 画像（<picture>）生成 ---- */
                    const picture = document.createElement('picture');

                    // AVIF
                    const avif = document.createElement('source');
                    avif.type = 'image/avif';
                    avif.dataset.srcset = pageData.src.replace(/\.jpe?g$/i, '.avif');
                    picture.appendChild(avif);

                    // WebP
                    const webp = document.createElement('source');
                    webp.type = 'image/webp';
                    webp.dataset.srcset = pageData.src.replace(/\.jpe?g$/i, '.webp');
                    picture.appendChild(webp);

                    // img 本体
                    const img = new Image();
                    img.classList.add('page-content');
                    img.alt = `マンガ ${index + 1}ページ目`;
                    img.loading = 'lazy';
                    img.width = IMAGE_W;
                    img.height = IMAGE_H;
                    img.dataset.src = pageData.src;

                    // 最初のページは即読み込み
                    if (index === 0) {
                        img.src = pageData.src;
                        avif.srcset = avif.dataset.srcset;
                        webp.srcset = webp.dataset.srcset;
                        img.classList.add('loading');
                    }

                    img.onload = () => handleImageLoad(img, index + 1);
                    img.onerror = () => handleImageError(img, index + 1);

                    picture.appendChild(img);
                    pageDiv.appendChild(picture);
                    mangaPagesContainer.appendChild(pageDiv);
                });

                updatePageIndicator();
                updateButtonStates();
                updatePageSpecificStyles(currentPage);
                setupEventListeners();
            }

            /* ---------- 画像ロード ---------- */
            function handleImageLoad(img, pageNum) {
                img.classList.remove('loading');
                img.classList.add('loaded');

                if (pageNum === currentPage) {
                    isLoading = false;
                    loadingSpinner.classList.remove('visible');
                    updatePageSpecificStyles(currentPage);
                }

                if (pageNum === currentPage && currentPage < totalPages) {
                    loadPageImages(currentPage + 1);
                }
            }

            function handleImageError(img, pageNum) {
                console.error(`Error loading page ${pageNum}: ${img.dataset.src}`);
                img.classList.remove('loading');
                img.alt = `画像読み込みエラー (${pageNum}ページ目)`;
                if (pageNum === currentPage) {
                    isLoading = false;
                    loadingSpinner.classList.remove('visible');
                }
            }

            function loadPageImages(targetPage) {
                const vicinity = [targetPage - 1, targetPage, targetPage + 1];
                vicinity.forEach(p => {
                    if (p < 1 || p > totalPages) return;
                    const pageDiv = mangaPagesContainer.querySelector(`.manga-page[data-page-number="${p}"]`);
                    if (!pageDiv) return;

                    const picture = pageDiv.querySelector('picture');
                    const img = picture.querySelector('.page-content');
                    const avif = picture.querySelector('source[type="image/avif"]');
                    const webp = picture.querySelector('source[type="image/webp"]');

                    if (!img.src) {
                        img.src = img.dataset.src;
                        avif.srcset = avif.dataset.srcset;
                        webp.srcset = webp.dataset.srcset;
                        img.classList.add('loading');
                    }

                    if (p === currentPage && img.classList.contains('loading')) {
                        isLoading = true;
                        loadingSpinner.classList.add('visible');
                    }
                });
            }

            /* ---------- ページ操作 ---------- */
            function goToPage(pageNumber) {
                if (pageNumber < 1 || pageNumber > totalPages || isLoading) return;

                const targetImg = mangaPagesContainer
                    .querySelector(`.manga-page[data-page-number="${pageNumber}"] .page-content`);

                if (!targetImg || !targetImg.classList.contains('loaded')) {
                    isLoading = true;
                    loadingSpinner.classList.add('visible');
                }

                currentPage = pageNumber;
                const offset = (currentPage - 1) * -100;
                mangaPagesContainer.style.transform = `translateX(${offset}%)`;

                updatePageIndicator();
                updateButtonStates();
                updatePageSpecificStyles(currentPage);
                loadPageImages(currentPage);
            }

            /* ---------- UI 更新 ---------- */
            function updatePageIndicator() {
                const text = `${currentPage} / ${totalPages}`;
                pageIndicatorTop.textContent = text;
                pageIndicatorBottom.textContent = text;
            }

            function updateButtonStates() {
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = currentPage === totalPages;
            }

            function updatePageSpecificStyles(pageNum) {
                if (pageNum === ACTION_BUTTON_PAGE) {
                    actionButton.classList.add('visible');
                } else {
                    actionButton.classList.remove('visible');
                }

                mangaPagesContainer.querySelectorAll('.manga-page').forEach((div, idx) => {
                    const num = idx + 1;
                    const img = div.querySelector('.page-content');
                    if (num === ACTION_BUTTON_PAGE && img.classList.contains('loaded')) {
                        div.classList.add('page-filter-active');
                    } else {
                        div.classList.remove('page-filter-active');
                    }
                });
            }

            function toggleUI() {
                isUIVisible = !isUIVisible;
                mangaViewer.classList.toggle('show-ui', isUIVisible);
            }

            /* ---------- イベント ---------- */
            function setupEventListeners() {
                prevZone.addEventListener('click', () => goToPage(currentPage - 1));
                nextZone.addEventListener('click', () => goToPage(currentPage + 1));
                prevButton.addEventListener('click', () => goToPage(currentPage - 1));
                nextButton.addEventListener('click', () => goToPage(currentPage + 1));
                centerZone.addEventListener('click', toggleUI);

                /* スワイプ */
                let touchStartX = 0, touchEndX = 0;
                mangaViewer.addEventListener('touchstart', e => {
                    if (isUIVisible) return;
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                mangaViewer.addEventListener('touchend', e => {
                    if (isUIVisible) return;
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, { passive: true });

                function handleSwipe() {
                    if (Math.abs(touchEndX - touchStartX) < SWIPE_THRESHOLD) return;
                    if (touchEndX < touchStartX) goToPage(currentPage + 1);
                    else goToPage(currentPage - 1);
                }

                /* キーボード操作 */
                document.addEventListener('keydown', e => {
                    if (e.key === 'ArrowRight') goToPage(currentPage + 1);
                    if (e.key === 'ArrowLeft')  goToPage(currentPage - 1);
                });
            }

            /* ---------- 実行 ---------- */
            initMangaViewer();
        });
    </script>
</body>
</html>
